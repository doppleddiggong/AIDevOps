name: AI Commit Message Suggestion

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  suggest-commit-message:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Make script executable
        run: chmod +x .github/scripts/ai_commit_suggestion.py

      - name: Generate AI Commit Message Suggestion
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESULT=$(python .github/scripts/ai_commit_suggestion.py \
            "${{ github.event.pull_request.number }}" \
            "${{ github.repository_owner }}" \
            "${{ github.event.repository.name }}")

          # JSON íŒŒì‹±í•˜ì—¬ ì¶œë ¥
          COMMIT_MSG=$(echo "$RESULT" | python -c "import sys, json; print(json.load(sys.stdin)['commit_message'])")

          # GitHub Actions Outputìœ¼ë¡œ ì „ë‹¬ (multiline)
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find existing comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'ğŸ¤– AI ì œì•ˆ ì»¤ë°‹ ë©”ì‹œì§€'

      - name: Create or Update PR Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## ğŸ¤– AI ì œì•ˆ ì»¤ë°‹ ë©”ì‹œì§€

            ```
            ${{ steps.generate.outputs.commit_message }}
            ```

            ---

            ### ğŸ“‹ ì ìš© ë°©ë²•

            #### Option 1: ë¡œì»¬ì—ì„œ ì ìš© (ê¶Œì¥)
            ```bash
            # PR ë¸Œëœì¹˜ë¡œ ì´ë™
            git checkout ${{ github.event.pull_request.head.ref }}

            # ìµœì‹  ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì •
            git commit --amend

            # ì—ë””í„°ì—ì„œ ìœ„ ë©”ì‹œì§€ë¡œ êµì²´ í›„ ì €ì¥

            # Force push
            git push --force-with-lease
            ```

            #### Option 2: GitHub Actionsë¡œ ìë™ ì ìš©
            ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìë™ìœ¼ë¡œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            **âš ï¸ ì£¼ì˜**: ì´ ì‘ì—…ì€ PRì˜ ë§ˆì§€ë§‰ ì»¤ë°‹ì„ amendí•˜ê³  force pushí•©ë‹ˆë‹¤.

            [ğŸ”„ Apply Suggestion](https://github.com/${{ github.repository }}/actions/workflows/apply-commit-suggestion.yml?query=workflow%3A%22Apply+Commit+Suggestion%22)

            ìœ„ ë§í¬ë¥¼ í´ë¦­í•œ í›„:
            1. "Run workflow" ë²„íŠ¼ í´ë¦­
            2. PR ë²ˆí˜¸ ì…ë ¥: `${{ github.event.pull_request.number }}`
            3. "Run workflow" ì‹¤í–‰

            ---

            <details>
            <summary>ğŸ“Š ë¶„ì„ ì •ë³´</summary>

            - **ë¶„ì„ëœ íŒŒì¼ ìˆ˜**: ${{ github.event.pull_request.changed_files }}
            - **ì¶”ê°€ëœ ì¤„**: +${{ github.event.pull_request.additions }}
            - **ì‚­ì œëœ ì¤„**: -${{ github.event.pull_request.deletions }}
            - **ë² ì´ìŠ¤ ë¸Œëœì¹˜**: `${{ github.event.pull_request.base.ref }}`
            - **í—¤ë“œ ë¸Œëœì¹˜**: `${{ github.event.pull_request.head.ref }}`

            </details>

            <sub>ğŸ¤– Generated with OpenAI GPT-4o-mini | [Feedback](https://github.com/${{ github.repository }}/issues)</sub>

      - name: Summary
        run: |
          echo "âœ… AI commit message suggestion has been posted!"
          echo "ğŸ“ PR #${{ github.event.pull_request.number }}"
          echo "ğŸ”— ${{ github.event.pull_request.html_url }}"
