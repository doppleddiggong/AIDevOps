name: Apply Commit Suggestion

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR ë²ˆí˜¸'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-suggestion:
    runs-on: ubuntu-latest

    steps:
      - name: Get PR Information
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.inputs.pr_number }}
            });

            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('pr_title', pr.title);

            console.log('PR Information:');
            console.log(`  Branch: ${pr.head.ref}`);
            console.log(`  SHA: ${pr.head.sha}`);
            console.log(`  Title: ${pr.title}`);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Make script executable
        run: chmod +x .github/scripts/ai_commit_suggestion.py

      - name: Generate AI Commit Message
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESULT=$(python .github/scripts/ai_commit_suggestion.py \
            "${{ github.event.inputs.pr_number }}" \
            "${{ github.repository_owner }}" \
            "${{ github.event.repository.name }}")

          # JSON íŒŒì‹±
          COMMIT_MSG=$(echo "$RESULT" | python -c "import sys, json; print(json.load(sys.stdin)['commit_message'])")

          # ì„ì‹œ íŒŒì¼ì— ì €ì¥
          echo "$COMMIT_MSG" > /tmp/commit_message.txt

          echo "âœ… Commit message generated:"
          cat /tmp/commit_message.txt

      - name: Apply Commit Message
        run: |
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì •
          git commit --amend -F /tmp/commit_message.txt

          echo "âœ… Commit amended successfully"

      - name: Force Push
        run: |
          # Force push with lease (ì•ˆì „ì¥ì¹˜)
          git push --force-with-lease origin ${{ steps.pr_info.outputs.head_ref }}

          echo "âœ… Changes pushed to ${{ steps.pr_info.outputs.head_ref }}"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.pr_number }},
              body: 'âœ… **AI ì œì•ˆ ì»¤ë°‹ ë©”ì‹œì§€ê°€ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!**\n\në§ˆì§€ë§‰ ì»¤ë°‹ì´ AIê°€ ì œì•ˆí•œ ë©”ì‹œì§€ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ¤– Applied by GitHub Actions'
            });

      - name: Summary
        run: |
          echo "âœ… Commit message has been applied successfully!"
          echo "ğŸ“ PR #${{ github.event.inputs.pr_number }}"
          echo "ğŸŒ¿ Branch: ${{ steps.pr_info.outputs.head_ref }}"
